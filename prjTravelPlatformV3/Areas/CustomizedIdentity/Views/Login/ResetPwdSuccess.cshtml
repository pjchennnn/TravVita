@model prjTravelPlatform_release.Areas.CustomizedIdentity.ViewModel.Customer.ResetPasswordViewModel
@{
    ViewData["Title"] = "重設密碼";
}

@section Styles {
    <style>
        .my-loading {
            z-index: 7700;
            position: fixed;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
            display: none;
        }

        .emp-container {
            background-color: #fff;
            border-radius: 20px;
            box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            position: relative;
            overflow: hidden;
            width: 500px;
            max-width: 100%;
            min-height: 480px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0 20px;
        }

    </style>
}

<div class="emp-container" id="container">
    <form id="ResetPwdForm">
        <a href="/">
            <img src="~/img/logof.png" style="width: 300px; height:50px" class="mb-3" />
        </a>
        <h3 class="mb-3">重設密碼</h3>
        <!--登入-->
        <input asp-for="@Model.Password" placeholder="請輸入密碼" type="password" />
        <span asp-validation-for="@Model.Password" class="ps-2 w-100 text-start text-danger"></span>
        <button id="btnForgetPwd" class="mt-3" id="btnLogin" type="button" onclick="btnResetPwdClick()">重設密碼</button>
        <input type="hidden" asp-for="@Model.token" />
        <input type="hidden" asp-for="@Model.UserId" />
    </form>
    <div>

        @section Scripts {
            <script>
                const token = document.getElementById('token');
                const UserId = document.getElementById('UserId');
                const btnForgetPwd = document.getElementById('btnForgetPwd');

                const btnResetPwdClick = async () => {
                    btnForgetPwd.innerHTML = `<div class="d-flex align-items-center"><img src="https://localhost:7119/img/frontstage/tube-spinner_w.svg" style = "width: 20px; height: 20px" />&ensp;${btnForgetPwd.innerHTML}</div>`;
                    const formData = new FormData(ResetPwdForm);

                    const res = await fetch("/api/ApiLogin/ResetPwd", {
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: formDataToJson(formData),
                        method: 'POST'
                    });
                    const resData = await res.json();
                    btnForgetPwd.innerHTML = "重設密碼";
                    if (resData.success) {
                        Swal.fire({
                            title: "修改密碼成功",
                            text: "請至登入畫面重新登入",
                            imageUrl: "https://localhost:7119/img/Hotel/RoomType/icons8-success.gif",
                            heightAuto: false,
                            imageHeight: 80
                        });
                        setTimeout(() => {
                            window.location.href = "/CustomizedIdentity/Login";
                        }, 2000);
                    } else {
                        if (resData.success === false) {
                            Swal.fire({
                                title: "Error",
                                text: resData.message,                             
                                imageUrl: "https://localhost:7119/img/Hotel/RoomType/delete-button_1.png",
                                heightAuto: false,
                                imageHeight: 80
                            });
                        }
                        const errPassword = document.querySelector('[data-valmsg-for="Password"]');
                        if (resData.errors.Password) {
                            errPassword.textContent = resData.errors.Password[0];
                        }
                    }
                }

                const formDataToJson = (formData) => {
                    let obj = {};
                    for (var [key, value] of formData.entries()) {
                        obj[key] = value;
                    }
                    console.log(JSON.stringify(obj));
                    return JSON.stringify(obj);
                }
            </script>
        }

