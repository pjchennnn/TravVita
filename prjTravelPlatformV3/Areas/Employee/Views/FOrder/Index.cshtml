@{
    ViewData["Title"] = "訂單管理";
}
@section Styles {
    <link href="~/lib/datatables/css/jquery.datatables.min.css" rel="stylesheet" />
    <style>
        thead {
            background-color: lightslategrey;
            color: black;
        }
    </style>
}

<h3>訂單管理</h3>

@Html.AntiForgeryToken()
<table class="table" id="tbOrder">
    <thead>
        <tr>
            <th style="display: none">FId</th>
            <th>訂單編號</th>
            <th>會員編號</th>
            <th>會員名稱</th>
            <th>訂單日期</th>
            <th>訂單狀態</th>
            <th>付款方式</th>
            <th>付款狀態</th>
            <th>折扣碼</th>
            <th>總金額</th>
            <th style="width:50px">功能</th>
        </tr>
    </thead>
</table>

@section Scripts {
    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>
    <script src="//cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#tbOrder').dataTable({
                autoWidth: false,
                ajax: {
                    type: 'GET',
                    url: "/api/Flight/loadOrderData",
                    dataSrc: function (json) { return json; }
                },
                columns: [
                    { "data": "fId", "visible": false },
                    { "data": "訂單編號" },
                    { "data": "會員編號" },
                    { "data": "會員名稱" },
                    { "data": "訂單日期" },
                    { "data": "訂單狀態" },
                    { "data": "付款方式" },
                    { "data": "付款狀態" },
                    { "data": "折扣碼" },
                    { "data": "總金額" },
                    {
                        data: null,
                        title: "功能",
                        render: function (data, type, row) {
                            return `<button id="btn1" type = "button" class="btn btn-primary btn-sm me-1" onclick="window.location.href = '/employee/forder/Edit?id=${row.fId}'"><i class="fa-solid fa-pen-to-square" style="font-size:0.8rem"></i> 編輯</button> ` +
                                `<button type="button" class="btn btn-danger btn-sm" onclick="ConfirmDelete(${row.fId})"><i class="fa-solid fa-trash" style="font-size:0.8rem"></i> 刪除</button>`
                        }
                    },
                ],
                fixedHeader: { header: true },
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json'
                },
            });

        });


        //刪除確認視窗
        async function ConfirmDelete(id) {
            //使用Swal（Swal.fire）的 JavaScript 函式庫彈出式提示框
            Swal.fire({
                title: '確認刪除',
                text: '刪除此訂單時，其相關的所有訂單細節皆會一併刪除，確定要刪除嗎？',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: '確定',
                cancelButtonText: '取消'
            }).then(async (result) => {
                if (result.isConfirmed) {
                    await DoDelete(id);
                }
            });
        }

        //執行刪除動作
        async function DoDelete(id) {

            var formdata = new FormData();
            //[ValidateAntiForgeryToken]防偽標籤
            formdata.append('__RequestVerificationToken', document.getElementsByName('__RequestVerificationToken')[0].value);
            //前端抓到的Id
            formdata.append("Id", id);

            let response = await fetch('/api/Flight/DoDeleteOrder', {
                method: 'post',
                body: formdata  //將上面的formData回傳
            })
            const data = await response.text();

            //關閉刪除視窗
            Swal.fire({
                title: data === '刪除成功!' ? 'Success' : 'Error',
                text: data,
                icon: data === '刪除成功!' ? 'success' : 'error'
            }).then((result) => {
                // 如果刪除成功，重新載入頁面
                if (result.isConfirmed && data === '刪除成功!') {
                    //刷新datatable
                    $('#tbOrder').DataTable().ajax.reload();
                }
            });

        }
    </script>
}