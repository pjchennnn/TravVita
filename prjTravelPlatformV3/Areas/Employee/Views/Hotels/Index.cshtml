@model IEnumerable<prjTravelPlatformV3.Models.THotel>

@{
    ViewData["Title"] = "飯店管理";
}


@section Styles {
    <link href="~/lib/datatables/css/jquery.datatables.css" rel="stylesheet" />
    <style>
        thead {
            background-color: lightslategrey;
            color: black;
        }

        .images {
            /* display: grid;
                            grid-template-columns: 180px 180px 180px 180px;
                            gap: 5px;
                            justify-content: center;
                            margin: 20px 0 30px 0;
                            display: flex;
                            flex-wrap: wrap;*/
            position: relative;
        }

        .img-check {
            position: absolute;
        }
        /* .images .img-container {
                            }

                                .images .img-container .img-item {
                                    width: 180px;
                                    height: 150px;
                                    border-radius: 15px;
                                    position: relative;
                                }

                                .images .img-container .img-check {
                                    position: absolute;
                                    bottom: 8rem;
                                } */

        .pageTab {
            display: flex;
            border-radius: 100px;
            justify-content: center;
            margin: 20px 0 35px 0;
        }

        .pageTab_item {
            width: 100%;
            max-width: 170px;
            overflow: hidden;
            background-color: #eef1f2;
        }

            .pageTab_item:first-child {
                border-top-left-radius: 100px;
                border-bottom-left-radius: 100px;
            }

            .pageTab_item:last-child {
                border-top-right-radius: 100px;
                border-bottom-right-radius: 100px;
            }

            .pageTab_item .pageTab_link.is-current {
                pointer-events: none;
                color: #fff;
                background-color: #005bac;
            }

        .pageTab_link {
            border: none;
            line-height: 1.5rem;
            transition: background-color .2s ease-out,color .2s ease-out;
            border-radius: 100px;
            padding: 14px 20px;
            width: 100%;
        }

            .pageTab_link:hover {
                background-color: #dee4e6
            }

        .tabContent {
            display: none;
            margin: 20px 50px 25px 50px;
        }

            .tabContent.active {
                display: block;
            }

        .my-btn-group {
            display: flex;
            border-radius: 100px;
            justify-content: center;
            margin: 20px 0 35px 0;
        }

        .my-btn-item {
            width: 100%;
            max-width: 100px;
            overflow: hidden;
        }

            .my-btn-item:first-child {
                border-top-left-radius: 100px;
                border-bottom-left-radius: 100px;
            }


            .my-btn-item:last-child {
                border-top-right-radius: 100px;
                border-bottom-right-radius: 100px;
            }

            .my-btn-item .my-btn-link {
                border: none;
                line-height: 1rem;
                transition: background-color .2s ease-out,color .2s ease-out;
                border-radius: 100px;
                padding: 14px 20px;
                width: 100%;
            }
    </style>
}
<h3>飯店管理</h3>

<button id="t1" type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#hotelPartial" onclick="getEditPartial(0)"><i class="fa-solid fa-circle-plus" style="font-size:0.8rem"></i> 新增</button>

<table class="table" id="tbHotel">
    <thead>
        <tr>
            <th style="display: none">id</th>
            <th>飯店名稱</th>
            <th>飯店英文名稱</th>
            <th>地址</th>
            <th>電話</th>
            <th>區域</th>
            <th>統編</th>
            <th style="width:50px">功能</th>
        </tr>
    </thead>
</table>

<!--Modal-->
<div class="modal fade" id="hotelPartial" tabindex=" -1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div id="edit-modal">
                <!--引入 ModalPartial-->
            </div>
        </div>
    </div>
</div>


@section Scripts{

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script src="~/lib/datatables/js/jquery.datatables.min.js"></script>
    <script src="//cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script>

        const editModal = document.getElementById("edit-modal");
        const createModal = document.getElementById("create-modal");
        const btnSave = document.getElementById("btnSave");

        const loadHotelData = () => {
            $("#tbHotel").dataTable({
                autoWidth: false,
                ajax: {
                    type: 'GET',
                    url: "/api/Hotels/GetAll",
                    dataSrc: function (json) { return json; }
                },
                columns: [
                    { "data": "fHotelId", "visible": false },
                    { "data": "fHotelName" },
                    { "data": "fHotelEngName" },
                    { "data": "fHotelAddress" },
                    { "data": "fPhone" },
                    { "data": "fRegion" },
                    { "data": "fTexId" },
                    {
                        data: null,
                        title: "功能",
                        render: function (data, type, row) {
                            return `<button id="t1" type = "button" class="btn btn-primary btn-sm me-1" data-bs-toggle="modal" data-bs-target="#hotelPartial" onclick="getEditPartial(${row.fHotelId})"><i class="fa-solid fa-pen-to-square" style="font-size:0.8rem"></i> 編輯</button> ` +
                                '<button type="button" class="btn btn-danger btn-sm"><i class="fa-solid fa-trash" style="font-size:0.8rem"></i> 刪除</button>'
                        }
                    },
                ],

                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.7/i18n/zh-HANT.json'
                },


            })
        }

        //取得partial view，新增跟編輯都呼叫這個function，新增id參數帶0，編輯是選到的那列資料的id
        const getEditPartial = async (id) => {
            const response = await fetch(`@Url.Content("~/Employee/Hotels/GetPartial")?id=${id}`);
            const data = await response.text();
            editModal.innerHTML = data
        }

        const demoClick = () => {
            const hotelName = document.getElementById("HotelName");
            const HotelEngName = document.getElementById("HotelEngName");
            const HotelAddress = document.getElementById("HotelAddress");
            const Phone = document.getElementById("Phone");
            const Region = document.getElementById("Region");
            const TexId = document.getElementById("TexId");

            hotelName.value = "涵碧樓"
            HotelEngName.value = "The Lalu Sun Moon Lake"
            HotelAddress.value = "南投縣魚池鄉中興路142號"
            Phone.value = "0492855311"
            Region.value = "南投"
            TexId.value = "22692490"
        }

        //根據傳入的action name呼叫對應的api
        const sendFetchRequest = async (actionName) => {
            //抓取目前的form id
            const formId = document.querySelector("form").getAttribute('id');
            //目前的form id的DOM元素
            const formIdDOM = document.getElementById(`${formId}`)
            //新增form data物件
            const formData = new FormData(formIdDOM);

            const add = document.querySelectorAll('[data-name="exist"]');
            add.forEach(element => {
                formData.append('AddFacilities', element.getAttribute("value"));
            });

            const remove = document.querySelectorAll('[data-name="notExist"]');
            remove.forEach(element => {
                formData.append('RemoveFacilities', element.getAttribute("value"));
            });
            
            //取得防偽標籤
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            try {
                const res = await fetch(`@Url.Content("~/api/Hotels/")` + actionName, {
                    headers: {
                        'RequestVerificationToken': token,                       
                    },
                    body: formData,
                    method: 'POST'
                });
                if (!res.ok) {
                    throw new Error(`${res.status}`)
                }
                const data = await res.json();

                if (data.success) {
                    console.log(data);
                    //關閉modal
                    var myModal = bootstrap.Modal.getInstance(hotelPartial);
                    myModal.hide();
                    //顯示訊息
                    Swal.fire({
                        title: "Success",
                        text: data.message,
                        icon: "success"
                    });
                    //刷新datatable
                    $('#tbHotel').DataTable().ajax.reload();
                } else {
                    //依自己的form增加需要驗證的欄位(驗證規則在viewModel中)
                    const errorHotelName = document.querySelector(`[data-valmsg-for="HotelName"]`);
                    const errorPhone = document.querySelector(`[data-valmsg-for="Phone"]`);
                    if (errorHotelName) {
                        errorHotelName.textContent = data.errors.HotelName[0];
                    }
                    if (errorPhone) {
                        errorPhone.textContent = data.errors.Phone[0];
                    }
                }
            } catch (error) {
                Swal.fire({
                    title: "error",
                    text: error.message,
                    icon: "error"
                });
            }
        }


        //上傳圖片
        const uploadPic = () => {
            $("#file").click();
        }

        const onPictureChange = (event) => {

            const files = event.target.files;
            const preview = document.getElementById("preview");
            const noPhoto = document.getElementById("noPhoto");
            const maxFiles = 8; // 最大數量限制

            // 檢查是否超過限制
            if (files.length > maxFiles) {
                alert(`最多只能上傳 ${maxFiles} 張圖片`);
                event.target.value = '';
                return;
            }
            if (files) {
                var allowType = "image.*";
                preview.innerHTML = "";
                for (let i = 0; i < files.length; i++) {
                    // 檢查格式
                    if (!files[i].type.match(allowType)) {
                        alert("不支援上傳的格式!");
                        continue;
                    }
                    // 創建 FileReader
                    var reader = new FileReader();
                    reader.onload = function (event) {
                        const img = document.createElement('img');
                        img.src = event.target.result;
                        img.setAttribute("class", "col-4 img-fluid p-1 rounded-3");
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(files[i]);
                }
            }
        }

        const openTab = (event, tabName) => {

            // 隱藏所有選項卡內容
            tabcontent = document.getElementsByClassName("tabContent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }

            // 取消所有選項卡按鈕的啟用狀態
            tabLink = document.getElementsByClassName("pageTab_link");
            for (i = 0; i < tabLink.length; i++) {
                tabLink[i].classList.remove("is-current");
            }

            // 顯示特定選項卡內容，並將其對應的按鈕設置為啟用狀態
            document.getElementById(tabName).classList.add("active");
            event.currentTarget.className += " is-current";
        }

        const idList = [];

        const imgSelected = (id, event) => {

            if (event.target.getAttribute('data-imgName') === "noPhoto.jpg") {
                return;
            }
            // 獲取刪除按鈕元素
            const delBtn = document.getElementById("delBtn");
            // 如果選擇列表中包含當前圖片的ID
            if (idList.includes(id)) {
                // 從選擇列表中移除當前圖片的ID
                const index = idList.indexOf(id);
                idList.splice(index, 1);
                // 取消應用濾鏡效果
                event.target.style.filter = "";
                // 如果選擇列表為空，則禁用刪除按鈕
                if (idList.length === 0) {
                    delBtn.setAttribute("disabled", true);
                }
                return;
            }
            // 否則，啟用刪除按鈕
            delBtn.removeAttribute("disabled");
            // 應用濾鏡效果，使圖片變暗
            event.target.style.filter = "brightness(60%)";
            // 將圖片的ID添加到選擇列表中
            idList.push(id);
        }

        const deletePhotoClick = async (hotelId) => {
            const photoNum = idList.length;
            // Swal.fire({
            //     title: `確定要刪除這${photoNum}張圖片`,
            //     showDenyButton: true,
            //     confirmButtonText: "確定",
            //     denyButtonText: `取消`
            // }).then((result) => {
            //     /* Read more about isConfirmed, isDenied below */
            //     if (result.isConfirmed) {
            //         Swal.fire("刪除成功", "", "success");
            //     }
            // });
            const yes = confirm(`確定要刪除圖片，共${photoNum}張?`);
            if (yes) {
                try {
                    const res = await fetch("@Url.Content("~/api/Hotels/DeletePhoto")", {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(idList)
                    });
                    if (!res.ok) {
                        throw new Error(`${res.status}`)
                    }
                    const data = await res.json();
                    Swal.fire({
                        title: "Success",
                        text: data.message,
                        icon: "success"
                    });
                    await getEditPartial(hotelId);

                    const image = document.getElementById("image");
                    const imgTab = document.getElementById("img-tab");
                    const info = document.getElementById("info");
                    const infoTab = document.getElementById("info-tab");

                    infoTab.classList.remove("is-current");
                    info.classList.remove("active");
                    imgTab.classList.add("is-current");
                    image.classList.add("active");

                } catch (error) {
                    console.log(error.message);
                }
            }

        }

       
        //設施功能
        let tempArr1 = [];
        let tempArr2 = [];

        const selectF = (event) => {
            const key = parseInt(event.target.value);
            const value = event.target.innerText;
            const addFClick = document.getElementById("addFClick");
            if (tempArr1.map(item => item.id).includes(key)) {

                event.target.classList.remove("active");
                const index = tempArr1.map(item => item.id).indexOf(key);
                tempArr1.splice(index, 1);

                if (tempArr1.length === 0) {
                    addFClick.setAttribute("disabled", true);
                }
                console.log(tempArr1);
                return;
            }
            event.target.classList.add("active");
            addFClick.removeAttribute("disabled");
            tempArr1.push({ id: key, name: value });
            console.log(tempArr1);
        }

        const selectExistF = (event) => {
            const key = parseInt(event.target.value);
            const value = event.target.innerText;
            const removeFClick = document.getElementById("removeFClick");

            if (tempArr2.map(item => item.id).includes(key)) {

                event.target.classList.remove("active");
                const index = tempArr2.map(item => item.id).indexOf(key);
                tempArr2.splice(index, 1);

                if (tempArr2.length === 0) {
                    removeFClick.setAttribute("disabled", true);
                }
                console.log(tempArr2);
                return;
            }
            event.target.classList.add("active");
            removeFClick.removeAttribute("disabled");
            tempArr2.push({ id: key, name: value });
            console.log(tempArr2);
        }

        const addFacility = (event) => {
            const exist = document.getElementById("exist");
            //設定按鈕屬性
            for (let i = 0; i < tempArr1.length; i++) {
                const btn = document.createElement("button");
                btn.setAttribute("type", "button");
                btn.setAttribute("class", "p-2 list-group-item list-group-item-action");
                btn.setAttribute("value", tempArr1[i].id);
                btn.setAttribute("onclick", "selectExistF(event)");
                btn.setAttribute("data-name", "exist");
                btn.setAttribute("data-prop", "B");
                btn.setAttribute("name", "AddFacilities");
                btn.innerText = tempArr1[i].name
                exist.appendChild(btn);
            }
            //移除active元素
            const activeElements = document.querySelectorAll('[data-prop="A"]');
            activeElements.forEach(element => {
                if (element.classList.contains("active")) {
                    element.remove();
                }
            });
            //將新增按鈕隱藏
            //const addFClick = document.getElementById("addFClick");
            event.target.setAttribute("disabled", true);
            //將陣列清空
            tempArr1 = [];
        }

        const removeFacility = (event) => {
            const notExist = document.getElementById("notExist");
            //設定按鈕屬性
            for (let i = 0; i < tempArr2.length; i++) {
                const btn = document.createElement("button");
                btn.setAttribute("type", "button");
                btn.setAttribute("class", "p-2 list-group-item list-group-item-action");
                btn.setAttribute("value", tempArr2[i].id);
                btn.setAttribute("onclick", "selectF(event)");
                btn.setAttribute("data-name", "notExist");
                btn.setAttribute("data-prop", "A");
                btn.setAttribute("name", "RemoveFacilities");

                btn.innerText = tempArr2[i].name
                notExist.appendChild(btn);
            }
            
            //移除active元素
            const activeElements = document.querySelectorAll('[data-prop="B"]');
            activeElements.forEach(element => {
                if (element.classList.contains("active")) {
                    element.remove();
                }
            });
            //將新增按鈕隱藏
            event.target.setAttribute("disabled", true);
            //將陣列清空
            tempArr2 = [];
        }

        document.addEventListener('DOMContentLoaded', function () {
            loadHotelData();
        });

    </script>
 }

